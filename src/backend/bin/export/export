#!/usr/bin/env node

var async = require('async'),
    _ = require('underscore'),
    assert = require('assert'),
    program = require('commander'),
    fs = require('fs'),
    request = require('request'),
    exec = require('child_process').exec,
    imagesize = require('imagesize');

var DatabaseManager = require('../../data/'),
    configs = require('../../utils/configs'),
    guid = require('../../utils/guid');
    

///////////////////////////////////////////////////////////////////////////////

program
  .version('0.0.1')
  .option('    --collection [collectionname]', 'Export collection name: class, facility, photo, video')
  .parse(process.argv);

var debug = true;


///////////////////////////////////////////////////////////////////////////////
// Export Facilities to Community
// 1. A facility will be the community in Fitmoo.com
//      a. Facility name, address and all other info should be imported to equivalent
//          fields in fitmoo.com
//          Example: URL will go to the external website link for community
//      b. Owner name can be added to the description as a new line eventually this
//          will the admin account.
//      c. Owner Email should be stored in an owner email field. (This field will be
//          used for claiming a community profile in the claiming functionality)
//      d. Only import Status = 2 //Done
//      e. Or a csv file may be provided.
///////////////////////////////////////////////////////////////////////////////


/**
 * Gets the facilities to export.
 */
function getVerifiedFacilities(facilityService, callback) {
    var opts = { status: 2 };
    if (debug)
        opts = { _id: "52736bea5c4c8caa03000176" };

    facilityService.modelClass.find(opts, callback);
}

function getVerifiedFacilities_photo(facilityService, callback) {
    var opts = { status: 2, downloadImage: {$ne : true}  };
    if (debug)
        opts = { _id: "52736bea5c4c8caa03000176" }; //52736bca5c4c8caa03000158

    facilityService.modelClass.find(opts, callback);
}

function getClassesByFacility(classService, facility, callback) {
    var opts = {
        facilityID: facility._id
    };

    classService.modelClass.find(opts, callback);
}


function getCommunityLocation(facility) {
    return facility.address + ' ' + facility.city + ', ' + facility.state;
}
/**
 * Given the facility object, build the community object
 */
function buildCommunity(facility) {
    var obj = {
        id: facility._id,
        facilityname: facility.facilityName,
        description:  facility.aboutus,
        location: getCommunityLocation(facility),
        country: facility.country,
        phone : facility.phoneNumber,
        email: facility.email, 
        website: facility.websiteURL,
        zip : facility.zip
    }


    if(facility.ownersName && facility.ownersName.trim().length > 0){
        obj.description += ' /n' + facility.ownersName;
    }

    return obj;
}

/**
*   Given the Video, build the export video object
*/
function buildVideo(facilityId, video){
    var obj = {
        facilityId : facilityId,
        videoId: video._id,
        url: video.url,
    }

    return obj;
}
/**
 * Migration facilities data to fitmoo.com's community data
 */
function exportFacilities(callback){

    if (program.collection !== 'facility')
        return callback && callback();

    var db = new DatabaseManager(configs);

    db.init(["Facility", "ExportFacility"], function(){
        var facilityService = db.getInstance("Facility"),
            exportFacility = db.getInstance("ExportFacility");

        // Remove all previously migrated records in mongo
        exportFacility.modelClass.collection.remove(function(err, count){

            console.log('Removed previous migration data: ' + count);

            //facilityService.modelClass.find(, function(err, facilities){
            // Find all verified facilitites
            var qryFacility = { status: 2 };
            if (debug)
                qryFacility = {_id: "52736a625c4c8caa03000004"};

            // Gets out all verified facilities to export
            getVerifiedFacilities(facilityService, function(err, facilities){
                console.log('facilities found: ' + facilities.length);

                async.eachSeries(facilities, function(facility, callback){

                    // builds the community object, given the facility object
                    var obj = buildCommunity(facility);

                    // Saves the community object to mongo so that we can
                    // export this to csv later.
                    exportFacility.create(obj, function(err, result){
                        if (debug)
                            console.log(result);
                        callback && callback(err);
                    });

                }, function(err){
                    callback && callback(err);
                });
            });
        });

    });
}




///////////////////////////////////////////////////////////////////////////////
// Export Events
// A class for a particular date and time is an event in Fitmoo.com
///////////////////////////////////////////////////////////////////////////////



function getDatebyDay(firstDayOfSecondWeek, stringDay, timeString){
    //"endTime" : "05:30 PM"
    var dayNumber = getDayNumber(stringDay);
    var dat = new Date(firstDayOfSecondWeek.getTime());

    dat.setUTCDate(dat.getDate() +  dayNumber);

    var index = timeString.indexOf(":"),
        length = timeString.length,
        hour = parseInt(timeString.substring(0, index)),
        mins = parseInt(timeString.substring(index + 1, index + 3)),
        meridiem = timeString.substring(length - 2, length);

    if(meridiem.toLowerCase() == 'pm'){
        if(hour != 12)
            hour += 12;
    }

    dat.setUTCHours(hour);
    dat.setUTCMinutes(mins);

    return dat;
}

function getFirstDayOfSecondWeek(){
    var currentDate = new Date();
    var firstDayOfSecondWeek = new Date('01-01-' + currentDate.getFullYear().toString());

    firstDayOfSecondWeek.setDate(firstDayOfSecondWeek.getDate() +  (7 - firstDayOfSecondWeek.getDay()));

    return firstDayOfSecondWeek;

}

function getDayNumber(stringDay){
    stringDay = stringDay.toLowerCase();

    switch(stringDay)
    {
        case "sunday":
            return 0;
        case "monday":
            return 1;
        case "tuesday":
            return 2;
        case "wednesday":
            return 3;
        case "thursday":
            return 4;
        case "friday":
            return 5;
        case "saturday":
            return 6;
    }
}

function exportClassesAndEvents(callback){
    if (program.collection !== 'class')
        return callback && callback();

    var db = new DatabaseManager(configs);

    db.init(["Facility", "Class", "ExportEvent"], function(){
        var classService = db.getInstance("Class"),
            facilityService = db.getInstance("Facility"),
            exportEventService = db.getInstance("ExportEvent");

        exportEventService.modelClass.collection.remove(function(err, count){

            console.log('Removed previous migration data: ' + count);

            // Gets out all verified facilities to export
            getVerifiedFacilities(facilityService, function(err, facilities){
                console.log('facilities found: ' + facilities.length);

                async.eachSeries(facilities, function(facility, callback){

                    // Gets all classes for the current facility
                    getClassesByFacility(classService, facility, function(err, classes) {
                        if (debug)
                            console.log('found', classes.length, 'classes');

                        var firstDayOfSecondWeek =  getFirstDayOfSecondWeek();
                        async.eachSeries(classes, function(classItem, callback){
                            // console.log('process class', classItem);
                            var location = getCommunityLocation(facility);

                            async.eachSeries(classItem.schedule, function(scheduleItem, callback){

                                async.eachSeries(scheduleItem.times, function(timeItem, callback){

                                    var startDate = getDatebyDay(firstDayOfSecondWeek, scheduleItem.dayOfWeek, timeItem.startTime);
                                    var endDate = getDatebyDay(firstDayOfSecondWeek, scheduleItem.dayOfWeek, timeItem.endTime);

                                    // Description: {Event name} + “ /n” + {if there is instructor} Instructor: {instructor name} {endif}
                                    var desc = classItem.className;
                                    if (classItem.instructor && classItem.instructor.trim().length > 0) {
                                        console.log('class has instructor', classItem);
                                        desc = desc + " /n" + classItem.instructor;
                                    }



                                    var obj = {
                                        // Link Class (Event) to Facility (Community) using FacilityID
                                        facilityId: facility._id,

                                        // ClassName = Event Name
                                        eventName : classItem.className,
                                        startDateTime : startDate,
                                        endDateTime : endDate,
                                        recurring: "weekly",
                                        eventDescription: desc,
                                        location: location
                                    }

                                    if(debug){
                                        console.log(obj);
                                        console.log('classid ' + classItem._id);
                                        console.log('scheduleItem ' + scheduleItem._id);    
                                        console.log('dayOfWeek ' + scheduleItem.dayOfWeek);    
                                        console.log('timeItem.startTime: ' + timeItem.startTime);
                                        console.log('timeItem.endTime: ' + timeItem.endTime);
                                        console.log()
                                        exportEventService.create(obj, function(err, count){
                                            console.log('Finish');
                                        });
                                    }
                                    else{
                                        exportEventService.create(obj, callback);
                                    }
                                    

                                }, function(err){
                                    callback && callback(err);
                                }); // async.eachSeries(scheduleItem.times

                            }, callback); // async.eachSeries(classItem.schedule

                        }, callback); // async.eachSeries(classes
                    }); // getClasses

                }, callback); // async.eachSeries(facilities

            }); // getVerifiedFacilities
        });

    });
};



///////////////////////////////////////////////////////////////////////////////
// Export Photos
///////////////////////////////////////////////////////////////////////////////


function getPhotosByFacility(photoService, facility, callback) {
    var opts = {
        facilityID : facility._id
        
    };
    
    photoService.photoS3.find(opts, function(err, photos){
        //Add facility.images to the result
        async.eachSeries(facility.images, function(image, callback){

            var newImage = {
                _id: image.id,
                facilityID : facility._id,
                errMessage : "",
                s3UploadStatus : false,
                sourceURL : image.url,
            }
            
            photos.push(newImage);
            callback();
        }, function(err){
            callback && callback(err, photos);
        })


    });
}

function buildAlbumPhoto(photo, fileName, width, height) {
    var obj = {
        facilityId : photo.facilityID,
        url: photo.sourceURL,
        fileName: fileName,
        photos3Id: photo._id,
        index : photo.index,
        width : width,
        height : height,
    }

    return obj;
}



function exportPhotos(callback){
    if (program.collection !== 'photo')
        return callback && callback();

    var db = new DatabaseManager(configs);

    db.init(['Facility', 'Class', 'ExportPhoto', 'Photo'], function() {
        var facilityService = db.getInstance("Facility"),
            photoS3Service = db.getInstance("Photo"),
            exportPhoto = db.getInstance("ExportPhoto");

        // Gets out all verified facilities to export
        getVerifiedFacilities_photo(facilityService, function(err, facilities){
            console.log('facilities found: ' + facilities.length);

            async.eachSeries(facilities, function(facility, callback) {

                // Get all photos for the current facilities
                getPhotosByFacility(photoS3Service, facility, function(err, photos) {
                    var length = photos.length;

                    exportPhoto.modelClass.remove({facilityId: facility._id}, function(err){
                        console.log('Deleted obsolete image for facilityId: %s', facility.id);
                        console.log('Start download %s image(s) for facilityId: %s', length, facility.id);

                        var count = 0;

                        async.eachSeries(photos, function(photo, callback) {
                            
                            console.log(photo.sourceURL);

                            downloadFileByWget(photo.sourceURL, "photos", function(fileName){
                                
                                //Create exportPhoto
                                if(fileName){
                                    count++;
                                    getImageSize("photos/" + fileName, function(err, result){
                                        if(err){
                                            callback(err)
                                        } else{
                                            var obj = buildAlbumPhoto(photo, fileName, result.width, result.height);
                                            // console.log('Image size: ' + result);
                                            exportPhoto.create(obj, callback);        
                                        }
                                    })
                                    
                                    
                                    
                                } else{
                                    console.log('Download failed: %s', photo.sourceURL);
                                    callback();
                                }
                            })

                        }, function(err){
                            facility.downloadImage = true;
                            facility.save(function(err, savedFacility){
                                console.log('Finish download %s images(s) facilityId: %s', count, facility.id);
                                callback && callback();
                            })
                        });

                    })

                });

              
            }, callback);
        });
    });
}

function downloadFile(uri, folder, callback){

    // if(debug)
         // uri = "http://districtcrossfit.com/wp-content/uploads/2013/05/MDM2013-136-1024x682-150x150.jpg";

    request.head(uri, function(err, res, body){
        if(err || !res){
            callback && callback();  
        } else{

            //console.log('content-type:', res.headers['content-type']);
            //console.log('content-length:', res.headers['content-length']);

            var content_type = res.headers['content-type'];

            if(res.statusCode == 200 && res.headers['content-length'] && content_type && content_type.toLowerCase().indexOf('image') >= 0){

                //image/jpeg;charset=UTF-8
                var separateIndex = content_type.indexOf("/");
                var separateEndingIndex = content_type.indexOf(";");

                if(separateIndex >= 0){
                    if (separateEndingIndex > separateIndex)
                        content_type = content_type.substring(separateIndex + 1, separateEndingIndex);
                    else{
                        content_type = content_type.substring(separateIndex + 1, content_type.length);
                    }
                }
                    

                var fileName = guid.generate()  + '.' + content_type;
                var filePath = folder + "/" + fileName;
                var writeStream = fs.createWriteStream(filePath);

                writeStream.on('close', function(){
                    return callback && callback(fileName);
                    
                })

                writeStream.on('error', function(){
                    console.log('writeStream Error');
                    //return callback && callback();
                })
            
                request({
                    uri : uri,
                    timeout : 9000   
                }, function(err){
                    //on error
                    if(err){
                        console.log('request error: ' + err);
                        //return callback && callback();
                    } else{
                        // console.log('request end');
                    }
                })
                //.pipe(writeStream)
                .on('data', function(data){
                    // console.log('data');
                    writeStream.write(data);
                })
                .on('end', function(){
                    //console.log('end');
                    writeStream.end();
                })
                .on('error', function(){
                    //console.log('error');
                    if(fileName)
                        fs.unlinkSync(filePath)
                    fileName = null;
                })

                    
            } else{
                callback && callback();  
            }
        }
    });
};


function downloadFileByWget(uri, folder, callback){

    // if(debug)
    //      uri = "http://64.19.142.10/hybridathletics.net/wp-content/uploads/yoke.png";

    request.head({
        timeout: 5000,
        uri : uri
    }, function(err, res, body){
        if(err || !res){
            callback && callback();  
        } else{

            // console.log('content-type:', res.headers['content-type']);
            // console.log('content-length:', res.headers['content-length']);

            var content_type = res.headers['content-type'];

            if(res.statusCode == 200 && res.headers['content-length'] && content_type && content_type.toLowerCase().indexOf('image') >= 0){


                //image/jpeg;charset=UTF-8
                var separateIndex = content_type.indexOf("/");
                var separateEndingIndex = content_type.indexOf(";");

                if(separateIndex >= 0){
                    if (separateEndingIndex > separateIndex)
                        content_type = content_type.substring(separateIndex + 1, separateEndingIndex);
                    else{
                        content_type = content_type.substring(separateIndex + 1, content_type.length);
                    }
                }
                    

                var fileName = guid.generate()  + '.' + content_type;
                var filePath = folder + "/" + fileName;

                
                var wget = 'wget ' + ' -T 5 -t 1 ' + ' "' + uri + '"' + ' --output-document ' + filePath;
                var child = exec(wget, function(err, stdout, stderr) {
                    if (err){
                        if (fs.existsSync(filePath)) {
                            fs.unlinkSync(filePath)
                        }
                        console.log('Error on wget ' + err);
                        callback && callback();
                    }
                    else {
                        //console.log(fileName + ' downloaded to ' + folder);
                        callback && callback(fileName);
                    }
                });


                    
            } else{
                callback && callback();  
            }
        }
    });
};

function getImageSize(filePath, callback){
    var stream = fs.createReadStream(filePath);

    imagesize(stream, function (err, result) {
      // if (!err) {
      //   console.log(result); // {type, width, height}
      // }
      callback(err, result);
    });
}

///////////////////////////////////////////////////////////////////////////////



///////////////////////////////////////////////////////////////////////////////
// Export Video
// Export video links for verified facilities
///////////////////////////////////////////////////////////////////////////////

function exportVideos(callback){
    if (program.collection !== 'video')
        return callback && callback();

    var db = new DatabaseManager(configs);

    db.init(["Facility", "ExportVideo"], function(){
        var facilityService = db.getInstance("Facility"),
            exportVideoService = db.getInstance("ExportVideo");

        getVerifiedFacilities(facilityService, function(err, facilities){

            async.eachSeries(facilities, function(facility, callback){
                
                //console.log(facility.video.length);
                
                if(facility.video){
                    
                    var videos = facility.video;
                    
                    async.eachSeries(videos, function(video, callback){
                        
                        var exportVideo = buildVideo(facility._id, video);
                        
                        exportVideoService.create(exportVideo, function(error, savedVideo){

                            console.log(savedVideo);
                            //https://github.com/caolan/async/issues/75
                            // callback();    
                            process.nextTick(function(){
                                callback(err)
                            });    
                        })
                        
                        
                    }, function(err){
                        callback && callback(err);
                    })
                    
                } else{
                    callback();
                }

                

            }, function(err){
                callback && callback(err);
            }) //end async.eachSeries(facilities...)
        }) //getVerifiedFacilities
    });
}

///////////////////////////////////////////////////////////////////////////////


function executeDebug(callback){
    if (program.collection !== 'debug')
        return callback && callback();

    else{
        var firstDayOfSecondWeek = getFirstDayOfSecondWeek();
        console.log('first day of the second week: %s', firstDayOfSecondWeek);

        var dayOfWeek = 'thursday'
        var startTime = '06:30 AM'
        var startDate = getDatebyDay(firstDayOfSecondWeek, dayOfWeek, startTime);
        console.log('Datetime : ' + startDate);

    }
}

async.series([
    exportFacilities,
    exportClassesAndEvents,
    exportPhotos,
    exportVideos,
    executeDebug,

], function(err, res) {
    assert.ok(!err, "E9984837323. Command fail");

    var exit = function () {
        process.exit(0);
    }

    if (!program.waitingExit)
        exit();
    else
        setTimeout(exit, program.waitingExit);
});